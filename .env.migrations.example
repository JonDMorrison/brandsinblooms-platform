# Supabase Migration Configuration
# Add these variables to your Railway/hosting environment

# =============================================================================
# REQUIRED - Database Connection
# =============================================================================

# Option 1: Direct database URL (recommended for migrations)
SUPABASE_DB_URL=postgresql://postgres:[password]@db.[project].supabase.co:5432/postgres

# Option 2: Alternative database URL format
DATABASE_URL=postgresql://postgres:[password]@db.[project].supabase.co:5432/postgres

# Supabase API Configuration (required for Node.js runner)
NEXT_PUBLIC_SUPABASE_URL=https://[project].supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJ[...]  # Service role key for admin access

# =============================================================================
# MIGRATION CONTROL
# =============================================================================

# Skip migrations entirely (useful for debugging)
SKIP_MIGRATIONS=false

# Use Node.js migration runner (recommended) or shell script
USE_NODE_MIGRATIONS=true

# Migration timeout in seconds (default: 300 = 5 minutes)
MIGRATION_TIMEOUT=300

# Number of retry attempts for failed migrations
MIGRATION_RETRY_COUNT=3

# Delay between retry attempts in seconds
MIGRATION_RETRY_DELAY=10

# Timeout for acquiring migration lock in seconds
MIGRATION_LOCK_TIMEOUT=60

# =============================================================================
# MONITORING & NOTIFICATIONS (Optional)
# =============================================================================

# Webhook URL for migration status notifications
# Supports Slack, Discord, or custom webhooks
MONITORING_WEBHOOK=https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXX

# =============================================================================
# APPLICATION SETTINGS
# =============================================================================

# Environment (migrations only run in production/staging)
NODE_ENV=production

# Application startup delay in seconds (gives migrations time to start)
APP_STARTUP_DELAY=2

# =============================================================================
# RAILWAY-SPECIFIC SETTINGS
# =============================================================================

# Railway automatically provides:
# - PORT (do not set manually)
# - RAILWAY_ENVIRONMENT
# - RAILWAY_PROJECT_ID
# - RAILWAY_DEPLOYMENT_ID

# =============================================================================
# EXAMPLE CONFIGURATIONS
# =============================================================================

# --- Production (Railway) ---
# NODE_ENV=production
# SUPABASE_DB_URL=${{SUPABASE_DB_URL}}
# NEXT_PUBLIC_SUPABASE_URL=${{NEXT_PUBLIC_SUPABASE_URL}}
# SUPABASE_SERVICE_ROLE_KEY=${{SUPABASE_SERVICE_ROLE_KEY}}
# SKIP_MIGRATIONS=false
# USE_NODE_MIGRATIONS=true
# MONITORING_WEBHOOK=${{SLACK_WEBHOOK}}

# --- Staging (Railway) ---
# NODE_ENV=staging
# SUPABASE_DB_URL=${{STAGING_SUPABASE_DB_URL}}
# NEXT_PUBLIC_SUPABASE_URL=${{STAGING_SUPABASE_URL}}
# SUPABASE_SERVICE_ROLE_KEY=${{STAGING_SERVICE_KEY}}
# SKIP_MIGRATIONS=false
# USE_NODE_MIGRATIONS=true
# MIGRATION_RETRY_COUNT=5

# --- Development (Local Docker) ---
# NODE_ENV=development
# SUPABASE_DB_URL=postgresql://postgres:postgres@host.docker.internal:54321/postgres
# NEXT_PUBLIC_SUPABASE_URL=http://localhost:54321
# SUPABASE_SERVICE_ROLE_KEY=eyJ[...local-service-key...]
# SKIP_MIGRATIONS=true  # Usually skip in dev

# =============================================================================
# SECURITY NOTES
# =============================================================================

# 1. NEVER commit actual values to version control
# 2. Use Railway's secret management for sensitive values
# 3. Rotate SERVICE_ROLE_KEY regularly
# 4. Use connection pooling for production databases
# 5. Enable SSL for database connections in production

# =============================================================================
# TROUBLESHOOTING
# =============================================================================

# If migrations fail to run:
# 1. Check NODE_ENV is set to production or staging
# 2. Verify SUPABASE_DB_URL is correct and accessible
# 3. Ensure SUPABASE_SERVICE_ROLE_KEY has admin permissions
# 4. Check container logs: railway logs
# 5. Manually run: docker exec [container] /app/scripts/run-migrations.sh

# To force skip migrations temporarily:
# SKIP_MIGRATIONS=true

# To increase timeout for large migrations:
# MIGRATION_TIMEOUT=600  # 10 minutes

# To debug lock issues:
# MIGRATION_LOCK_TIMEOUT=120  # 2 minutes