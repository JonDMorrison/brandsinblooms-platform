# Railway deployment configuration
# Optimized for production performance and multi-domain support

[build]
builder = "DOCKERFILE"
dockerfilePath = "Dockerfile.production"

[build.cache]
# Enable build caching for faster deployments
enabled = true
paths = [
  "node_modules",
  ".next/cache",
  "/root/.local/share/pnpm/store"
]

[deploy]
# Health check configuration
healthcheckPath = "/api/health"
healthcheckTimeout = 10000
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

# Initial replicas (auto-scales based on load)
numReplicas = 2
region = "us-west1"

# Memory and CPU limits
memory = "512Mi"
cpu = "0.5"

# Start command override (optional)
startCommand = "node server.js"

# Environment-specific settings
[deploy.production]
numReplicas = 2
memory = "1Gi"
cpu = "1"

[deploy.staging]
numReplicas = 1
memory = "512Mi"
cpu = "0.5"

# Service configuration
[[services]]
name = "web"
internal = false
port = 3000
protocol = "HTTP"

# Domain configuration for multi-tenant support
[domains]
# Production domains with wildcard support
production = [
  "${{RAILWAY_PUBLIC_DOMAIN}}",
  "blooms.cc",
  "*.blooms.cc"
]

# Staging domains
staging = [
  "${{RAILWAY_STATIC_URL}}",
  "staging.blooms.cc",
  "*.staging.blooms.cc"
]

# Environment variables (Railway UI overrides)
[variables]
NODE_ENV = "production"
PORT = "${{PORT}}"
RAILWAY_ENVIRONMENT = "${{RAILWAY_ENVIRONMENT}}"

# Build-time variables
[build.variables]
NEXT_TELEMETRY_DISABLED = "1"
NODE_OPTIONS = "--max-old-space-size=4096"